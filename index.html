<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Mobilit√© - Joinville / Vincennes</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #0a1628;
      --panel: #132447;
      --chip: #0d1b35;
      --accent: #f5a623;
      --ok: #22c55e;
      --warning: #eab308;
      --error: #ef4444;
      --muted: #64748b;
      --text: #f1f5f9;
      --text-sec: #cbd5e1;
      --border: #1e3a5f;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      width: 1080px;
      height: 1920px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    /* ===== ZONE A: BANDEAU GLOBAL ===== */
    .zone-a {
      background: linear-gradient(135deg, #0f2847 0%, #132f52 100%);
      border-bottom: 3px solid var(--accent);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .zone-a-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .logo {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--accent), #ff8c00);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 24px;
      color: #000;
    }
    
    .zone-a-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .zone-a-title h1 {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
    }
    
    .zone-a-title p {
      font-size: 12px;
      color: var(--text-sec);
      margin: 0;
    }
    
    .zone-a-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    
    #heure {
      font-family: 'Courier New', monospace;
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
    }
    
    .zone-a-meta {
      font-size: 12px;
      color: var(--text-sec);
    }
    
    /* ===== ZONE B: C≈íUR TRANSPORT ===== */
    .zone-b {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .stop-block {
      background: var(--panel);
      border-radius: 12px;
      border-left: 5px solid var(--accent);
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .stop-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .lines-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .line-item {
      background: var(--chip);
      border-radius: 8px;
      padding: 10px;
      border-left: 3px solid var(--muted);
    }
    
    .line-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .line-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--muted);
      color: #fff;
      font-weight: 700;
      font-size: 13px;
    }
    
    .line-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }
    
    .directions-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding-left: 48px;
    }
    
    .direction-item {
      font-size: 12px;
      color: var(--text-sec);
      padding: 6px 0;
    }
    
    .direction-label {
      font-weight: 600;
      color: var(--text);
    }
    
    .passages {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }
    
    .passage-box {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      text-align: center;
      min-width: 70px;
    }
    
    .passage-time {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
    }
    
    .passage-heure {
      font-size: 11px;
      color: var(--text-sec);
      margin-top: 2px;
    }
    
    .passage-status {
      font-size: 9px;
      margin-top: 3px;
      padding: 2px 4px;
      border-radius: 3px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-ok { background: var(--ok); color: #000; }
    .status-warning { background: var(--warning); color: #000; }
    .status-error { background: var(--error); color: #fff; }
    .status-muted { background: var(--muted); color: #fff; }
    
    .no-passage {
      color: var(--muted);
      font-style: italic;
      font-size: 11px;
    }
    
    /* ===== ZONE C: VUE EXHAUSTIVE ===== */
    .zone-c {
      background: var(--panel);
      border-top: 2px solid var(--border);
      padding: 12px 20px;
      max-height: 180px;
      overflow-y: auto;
    }
    
    .zone-c-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    
    .all-bus-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      font-size: 11px;
    }
    
    .bus-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 6px 8px;
      border-radius: 4px;
      border-left: 2px solid var(--accent);
    }
    
    .bus-item-line {
      font-weight: 700;
      color: var(--accent);
    }
    
    .bus-item-dests {
      color: var(--text-sec);
      margin-top: 2px;
    }
    
    /* ===== ZONE D: MODULES CONTEXTUELS ===== */
    .zone-d {
      background: var(--panel);
      border-top: 2px solid var(--border);
      padding: 12px 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      flex-shrink: 0;
    }
    
    .module {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 10px;
      border-left: 3px solid var(--accent);
    }
    
    .module-title {
      font-size: 11px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 6px;
      text-transform: uppercase;
    }
    
    .module-content {
      font-size: 12px;
      color: var(--text);
      line-height: 1.4;
    }
    
    .module-content div {
      margin: 3px 0;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 3px;
    }
    
    /* Animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .imminent { animation: pulse 1s infinite; }
  </style>
</head>
<body>

  <!-- ZONE A: BANDEAU GLOBAL -->
  <div class="zone-a">
    <div class="zone-a-left">
      <div class="logo">VH</div>
      <div class="zone-a-title">
        <h1>Dashboard Mobilit√©</h1>
        <p>Joinville-le-Pont ‚Ä¢ Vincennes ‚Ä¢ Breuil</p>
      </div>
    </div>
    <div class="zone-a-right">
      <div id="heure">--:--:--</div>
      <div class="zone-a-meta">Maj <span id="lastUpdate">--:--</span></div>
    </div>
  </div>

  <!-- ZONE B: C≈íUR TRANSPORT -->
  <div class="zone-b" id="zone-b"></div>

  <!-- ZONE C: VUE EXHAUSTIVE -->
  <div class="zone-c">
    <div class="zone-c-title">üìç Tous les Bus - Joinville (Vue Compl√®te)</div>
    <div class="all-bus-grid" id="allBusGrid"></div>
  </div>

  <!-- ZONE D: CONTEXTE -->
  <div class="zone-d">
    <div class="module">
      <div class="module-title">üö≤ V√©lib'</div>
      <div class="module-content">
        <div>Vincennes: <strong id="velib-v">--</strong></div>
        <div>Breuil: <strong id="velib-b">--</strong></div>
      </div>
    </div>
    <div class="module">
      <div class="module-title">üå§Ô∏è M√©t√©o</div>
      <div class="module-content">
        <div><span id="weather-emoji">--</span> <strong id="weather-desc">--</strong></div>
        <div id="weather-temp">--</div>
      </div>
    </div>
  </div>

  <script>
    const proxy = 'https://ratp-proxy.hippodrome-proxy42.workers.dev/?url=';
    const enc = encodeURIComponent;
    
    // === CONFIG ===
    const COLORS = {
      'STIF:Line::C01742:': '#E41E26', // RER A
      'STIF:Line::C02251:': '#0071bc', // 77
      'STIF:Line::C01219:': '#6E491E', // 201
      'STIF:Line::C01130:': '#f0a500', // 101
      'STIF:Line::C01135:': '#e4002b', // 106
      'STIF:Line::C01137:': '#d10073', // 108
      'STIF:Line::C01139:': '#642580', // 110
      'STIF:Line::C01141:': '#ff5a00', // 112
      'STIF:Line::C01260:': '#d9a300', // 281
      'STIF:Line::C01399:': '#ff5a00'  // N33
    };
    
    const LINES = [
      { name: 'RER A', line: 'STIF:Line::C01742:', monitoring: ['STIF:StopArea:SP:43135:'], stop: 'Joinville - RER' },
      { name: '77', line: 'STIF:Line::C02251:', monitoring: ['STIF:StopPoint:Q:22452:'], stop: 'Joinville - Bus' },
      { name: '101', line: 'STIF:Line::C01130:', monitoring: ['STIF:StopPoint:Q:21252:'], stop: 'Joinville - Bus' },
      { name: '106', line: 'STIF:Line::C01135:', monitoring: ['STIF:StopPoint:Q:27560:'], stop: 'Joinville - Bus' },
      { name: '108', line: 'STIF:Line::C01137:', monitoring: ['STIF:StopPoint:Q:28032:'], stop: 'Joinville - Bus' },
      { name: '110', line: 'STIF:Line::C01139:', monitoring: ['STIF:StopPoint:Q:28032:'], stop: 'Joinville - Bus' },
      { name: '112', line: 'STIF:Line::C01141:', monitoring: ['STIF:StopPoint:Q:28065:', 'STIF:StopPoint:Q:39406:'], stop: 'Joinville - Bus' },
      { name: '201', line: 'STIF:Line::C01219:', monitoring: ['STIF:StopPoint:Q:39406:', 'STIF:StopPoint:Q:22452:'], stop: '√âcole du Breuil' },
      { name: '281', line: 'STIF:Line::C01260:', monitoring: ['STIF:StopPoint:Q:28033:'], stop: 'Joinville - Bus' },
      { name: 'N33', line: 'STIF:Line::C01399:', monitoring: ['STIF:StopPoint:Q:39406:'], stop: 'Joinville - Bus' }
    ];
    
    // === UTILS ===
    function updateClock() {
      const n = new Date();
      document.getElementById('heure').textContent = n.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    }
    
    function setLastUpdate() {
      const el = document.getElementById('lastUpdate');
      if(el) el.textContent = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
    }
    
    function minutesUntil(dateStr) {
      if(!dateStr) return null;
      const now = new Date();
      const t = new Date(dateStr);
      return Math.max(0, Math.round((t - now) / 60000));
    }
    
    function hhmm(dateStr) {
      if(!dateStr) return '--:--';
      return new Date(dateStr).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
    }
    
    // === FETCH ===
    async function fetchDepartures(line) {
      for(const m of line.monitoring) {
        try {
          const url = `${proxy}https://prim.iledefrance-mobilites.fr/marketplace/stop-monitoring?MonitoringRef=${enc(m)}&LineRef=${enc(line.line)}`;
          const res = await fetch(url);
          if(!res.ok) continue;
          const json = await res.json();
          const visits = json?.Siri?.ServiceDelivery?.StopMonitoringDelivery?.[0]?.MonitoredStopVisit || [];
          const filtered = visits.filter(v => v?.MonitoredVehicleJourney?.LineRef?.value === line.line);
          if(!filtered.length) continue;
          return filtered.map(v => {
            const mvj = v.MonitoredVehicleJourney;
            const call = mvj?.MonitoredCall;
            return {
              dest: mvj?.DestinationName?.[0]?.value || '‚Äì',
              time: call?.ExpectedDepartureTime || call?.AimedDepartureTime || null,
              status: (call?.DepartureStatus || 'onTime').toLowerCase()
            };
          });
        } catch(e) {
          console.error('Fetch error:', e);
        }
      }
      return [];
    }
    
    // === RENDER ZONE B ===
    async function renderZoneB() {
      const zoneB = document.getElementById('zone-b');
      zoneB.innerHTML = '';
      
      const stops = {};
      for(const line of LINES) {
        const deps = await fetchDepartures(line);
        const stop = line.stop;
        if(!stops[stop]) stops[stop] = { title: stop, lines: [] };
        stops[stop].lines.push({ line, deps });
      }
      
      for(const [stopKey, stop] of Object.entries(stops)) {
        const stopBlock = document.createElement('div');
        stopBlock.className = 'stop-block';
        
        const title = document.createElement('div');
        title.className = 'stop-title';
        title.textContent = stop.title;
        stopBlock.appendChild(title);
        
        const linesList = document.createElement('div');
        linesList.className = 'lines-list';
        
        for(const {line, deps} of stop.lines) {
          const lineItem = document.createElement('div');
          lineItem.className = 'line-item';
          lineItem.style.borderLeftColor = COLORS[line.line] || '#999';
          
          const header = document.createElement('div');
          header.className = 'line-header';
          const badge = document.createElement('div');
          badge.className = 'line-badge';
          badge.style.background = COLORS[line.line] || '#999';
          badge.textContent = line.name;
          const name = document.createElement('div');
          name.className = 'line-name';
          name.textContent = line.line.includes('C01742') ? 'RER A' : `Bus ${line.name}`;
          header.appendChild(badge);
          header.appendChild(name);
          lineItem.appendChild(header);
          
          const dirGroup = document.createElement('div');
          dirGroup.className = 'directions-group';
          
          if(!deps.length) {
            const dirItem = document.createElement('div');
            dirItem.className = 'direction-item';
            dirItem.innerHTML = '<span class="direction-label">Aucune direction</span> <span class="no-passage">Service indisponible</span>';
            dirGroup.appendChild(dirItem);
          } else {
            const byDest = {};
            deps.forEach(d => (byDest[d.dest] ||= []).push(d));
            for(const [dest, depsList] of Object.entries(byDest)) {
              const dirItem = document.createElement('div');
              dirItem.className = 'direction-item';
              
              const dirLabel = document.createElement('span');
              dirLabel.className = 'direction-label';
              dirLabel.textContent = dest.substring(0, 40);
              dirItem.appendChild(dirLabel);
              
              const passages = document.createElement('div');
              passages.className = 'passages';
              depsList.slice(0, 3).forEach(d => {
                const box = document.createElement('div');
                box.className = 'passage-box';
                const m = minutesUntil(d.time);
                let statusClass = 'status-ok';
                let statusText = 'OK';
                if(m === null) { statusClass = 'status-muted'; statusText = 'N/A'; }
                else if(d.status === 'cancelled') { statusClass = 'status-error'; statusText = 'ANNUL√â'; }
                else if(d.status === 'delayed') { statusClass = 'status-warning'; statusText = 'RETARD'; }
                else if(m < 2) { box.classList.add('imminent'); statusText = 'IMMINENT'; }
                
                box.innerHTML = `<div class="passage-time">${m === null ? '‚Äì' : m + ' min'}</div><div class="passage-heure">${hhmm(d.time)}</div><div class="passage-status ${statusClass}">${statusText}</div>`;
                passages.appendChild(box);
              });
              dirItem.appendChild(passages);
              dirGroup.appendChild(dirItem);
            }
          }
          lineItem.appendChild(dirGroup);
          linesList.appendChild(lineItem);
        }
        stopBlock.appendChild(linesList);
        zoneB.appendChild(stopBlock);
      }
    }
    
    // === RENDER ZONE C ===
    async function renderZoneC() {
      const grid = document.getElementById('allBusGrid');
      grid.innerHTML = '';
      
      for(const line of LINES) {
        if(line.line.includes('C01742')) continue; // Skip RER A
        const deps = await fetchDepartures(line);
        const item = document.createElement('div');
        item.className = 'bus-item';
        item.style.borderLeftColor = COLORS[line.line];
        
        const lineDiv = document.createElement('div');
        lineDiv.className = 'bus-item-line';
        lineDiv.style.color = COLORS[line.line];
        lineDiv.textContent = `‚óè Ligne ${line.name}`;
        item.appendChild(lineDiv);
        
        const destsDiv = document.createElement('div');
        destsDiv.className = 'bus-item-dests';
        const dests = [...new Set(deps.map(d => d.dest).slice(0, 2))];
        destsDiv.textContent = dests.join(' ‚Ä¢ ') || 'Aucun passage';
        item.appendChild(destsDiv);
        
        grid.appendChild(item);
      }
    }
    
    // === M√âT√âO ===
    async function refreshWeather() {
      try {
        const data = await fetch('https://api.open-meteo.com/v1/forecast?latitude=48.835&longitude=2.45&current_weather=true').then(r => r.json());
        if(data?.current_weather) {
          const {temperature, weathercode} = data.current_weather;
          const codes = {0:{e:'‚òÄÔ∏è',d:'Ensoleill√©'},1:{e:'üå§Ô∏è',d:'D√©gag√©'},2:{e:'‚õÖ',d:'Nuageux'},3:{e:'‚òÅÔ∏è',d:'Couvert'},45:{e:'üå´Ô∏è',d:'Brouillard'},61:{e:'üå¶Ô∏è',d:'Pluie'},80:{e:'‚õàÔ∏è',d:'Averses'}};
          const info = codes[weathercode] || codes[0];
          document.getElementById('weather-emoji').textContent = info.e;
          document.getElementById('weather-desc').textContent = info.d;
          document.getElementById('weather-temp').textContent = Math.round(temperature) + '¬∞C';
        }
      } catch(e) { console.error('Weather:', e); }
    }
    
    // === VELIB ===
    async function refreshVelib() {
      const stations = {v:'12163', b:'12128'};
      for(const [key, id] of Object.entries(stations)) {
        try {
          const data = await fetch(`https://opendata.paris.fr/api/explore/v2.1/catalog/datasets/velib-disponibilite-en-temps-reel/records?where=stationcode%3D${id}&limit=1`).then(r => r.json());
          const st = data?.results?.[0];
          const el = document.getElementById(`velib-${key}`);
          if(el) el.textContent = st ? (st.mechanical_bikes||0) + (st.ebike_bikes||0) + ' dispo' : 'N/A';
        } catch(e) { console.error('Velib:', e); }
      }
    }
    
    // === INIT ===
    setInterval(updateClock, 1000);
    updateClock();
    
    async function init() {
      await Promise.all([renderZoneB(), renderZoneC(), refreshWeather(), refreshVelib()]);
      setLastUpdate();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      init();
      setInterval(init, 60000);
    });
  </script>
</body>
</html>