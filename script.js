// Fusion helpers & modules robustes dans le script principal

// ===== D√©codage & nettoyage =====
function decodeEntities(str = "") {
  return String(str)
    .replace(/&nbsp;/gi, " ")
    .replace(/&amp;/gi, "&")
    .replace(/&quot;/gi, '"')
    .replace(/&#039;/gi, "'")
    .replace(/&apos;/gi, "'")
    .replace(/&lt;/gi, "<")
    .replace(/&gt;/gi, ">")
    .trim();
}
function cleanText(str = "") {
  return decodeEntities(String(str))
    .replace(/<br\s*\/?>(\s*)/gi, " ")
    .replace(/<[^>]*>/g, " ")
    .replace(/[<>]/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}
function minutesFromISO(iso) {
  if (!iso) return null;
  const mins = Math.round((new Date(iso).getTime() - Date.now()) / 60000);
  return mins < 0 ? null : mins;
}

// ===== R√©seau & horloge =====
async function fetchJSON(url, timeout = 12000) {
  try {
    const c = new AbortController();
    const t = setTimeout(() => c.abort(), timeout);
    const r = await fetch(url, { signal: c.signal, cache: 'no-store' });
    clearTimeout(t);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  } catch (e) {
    console.error('fetchJSON', url, e.message || e);
    return null;
  }
}
async function fetchText(url, timeout = 12000) {
  try {
    const c = new AbortController();
    const t = setTimeout(() => c.abort(), timeout);
    const r = await fetch(url, { signal: c.signal, cache: 'no-store' });
    clearTimeout(t);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.text();
  } catch (e) {
    console.error('fetchText', url, e.message || e);
    return '';
  }
}
function setClock() {
  const el = document.getElementById('clock');
  if (el) el.textContent = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
}
function setLastUpdate() {
  const el = document.getElementById('lastUpdate');
  if (el) el.textContent = `Maj ${new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
}

// ===== Constantes & PROXY =====
const PROXY = 'https://ratp-proxy.hippodrome-proxy42.workers.dev/?url=';
const API_BASE = 'https://prim.iledefrance-mobilites.fr/marketplace';
const WEATHER_URL = 'https://api.open-meteo.com/v1/forecast?latitude=48.835&longitude=2.45&current_weather=true';
const RSS_URL = 'https://www.francetvinfo.fr/titres.rss';
const STOP_IDS = {
  RER_A: 'STIF:StopArea:SP:43135:',
  HIPPODROME: 'STIF:StopArea:SP:463641:',
  BREUIL: 'STIF:StopArea:SP:463644:',
  JOINVILLE_BUSES: 'STIF:StopArea:SP:43135:'
};
const LINES_SIRI = {
  RER_A: 'STIF:Line::C01742:',
  BUS_77: 'STIF:Line::C02251:',
  BUS_201: 'STIF:Line::C02251:'
};
const VELIB_STATIONS = { VINCENNES: '12163', BREUIL: '12128' };
function primUrl(path, params = {}) {
  const u = new URL(API_BASE + (path.startsWith('/') ? path : `/${path}`));
  Object.entries(params).forEach(([k, v]) => { if (v !== undefined && v !== null && v !== '') u.searchParams.set(k, v); });
  return PROXY + encodeURIComponent(u.toString());
}

// ===== Parsing SIRI =====
function parseStop(data) {
  const visits = data?.Siri?.ServiceDelivery?.StopMonitoringDelivery?.[0]?.MonitoredStopVisit;
  if (!Array.isArray(visits)) return [];
  return visits.map(v => {
    const mv = v.MonitoredVehicleJourney || {};
    const call = mv.MonitoredCall || {};
    const lineRef = (mv.LineRef && (mv.LineRef.value || mv.LineRef)) || '';
    const lineId = (lineRef.match(/C\d{5}/) || [null])[0] || '?';
    const dd = call.DestinationDisplay;
    const rawDest = (Array.isArray(dd) ? dd[0]?.value : dd?.value) || (Array.isArray(dd) ? dd[0] : dd) || '';
    const destDisplay = cleanText(rawDest);
    const expected = call.ExpectedDepartureTime || call.ExpectedArrivalTime || null;
    const status = ((call.DepartureStatus || call.ArrivalStatus || 'onTime') + '').toLowerCase();
    return { lineId, dest: destDisplay || '‚Äî', minutes: minutesFromISO(expected), status };
  });
}

// ===== Rendu statuts & temps =====
function renderStatus(status, minutes) {
  const s = (status || '').toLowerCase();
  if (s === 'cancelled')   return '<span class="time-cancelled">‚ùå Supprim√©</span>';
  if (s === 'last')        return '<span class="time-last">üî¥ Dernier passage</span>';
  if (s === 'delayed')     return '<span class="time-delay">‚è≥ Retard√©</span>';
  if (s === 'notstopping') return '<span class="time-cancelled">üö´ Non desservi</span>';
  if (s === 'noservice')   return '<span class="time-cancelled">‚ö†Ô∏è Service termin√©</span>';
  if (minutes === 0)       return '<span class="time-imminent">üöâ √Ä quai</span>';
  return '<span class="time-estimated">üü¢ OK</span>';
}
function formatTimeBox(v) {
  const s = (v.status || '').toLowerCase();
  if (s === 'cancelled')   return '<div class="time-box time-cancelled">‚ùå Supprim√©</div>';
  if (s === 'last')        return '<div class="time-box time-last">üî¥ Dernier passage</div>';
  if (s === 'delayed')     return '<div class="time-box time-delay">‚è≥ Retard√©</div>';
  if (s === 'notstopping') return '<div class="time-box time-cancelled">üö´ Non desservi</div>';
  if (s === 'noservice')   return '<div class="time-box time-cancelled">‚ö†Ô∏è Service termin√©</div>';
  if (v.minutes === 0)     return '<div class="time-box time-imminent">üöâ √Ä quai</div>';
  if (v.minutes !== null && v.minutes <= 1) return '<div class="time-box time-imminent">üü¢ Imminent</div>';
  const label = Number.isFinite(v.minutes) ? `${v.minutes} min` : '‚Äî';
  return `<div class="time-box">${label}</div>`;
}

// ===== RER A =====
async function renderRer() {
  const cont = document.getElementById('rer-body');
  if (!cont) return; cont.textContent = 'Chargement‚Ä¶';
  const data = await fetchJSON(primUrl('/stop-monitoring', { MonitoringRef: STOP_IDS.RER_A, LineRef: LINES_SIRI.RER_A }));
  const visits = parseStop(data).slice(0, 6);
  cont.innerHTML = '';
  if (!visits.length) { cont.textContent = 'Aucun passage'; return; }
  for (const v of visits) {
    const row = document.createElement('div'); row.className = 'row';
    const pill = document.createElement('span'); pill.className = 'line-pill rer-a'; pill.textContent = 'A'; row.appendChild(pill);
    const destEl = document.createElement('div'); destEl.className = 'dest'; destEl.textContent = v.dest || '‚Äî'; row.appendChild(destEl);
    const timesEl = document.createElement('div'); timesEl.className = 'times'; timesEl.innerHTML = formatTimeBox(v); row.appendChild(timesEl);
    const statusEl = document.createElement('div'); statusEl.className = 'status'; statusEl.innerHTML = renderStatus(v.status, v.minutes); row.appendChild(statusEl);
    cont.appendChild(row);
  }
}

// ===== Bus (par arr√™t) =====
async function renderBusForStop(stopId, bodyId, trafficId) {
  const cont = document.getElementById(bodyId);
  const tEl  = document.getElementById(trafficId);
  if (!cont) return; cont.classList.remove('bus-grid'); cont.textContent = 'Chargement‚Ä¶'; if (tEl) { tEl.style.display = 'none'; tEl.className = 'traffic-sub ok'; tEl.textContent = ''; }
  if (!stopId) { cont.innerHTML = '<div class="traffic-sub alert">‚ö†Ô∏è Aucun arr√™t configur√©</div>'; return; }
  const data = await fetchJSON(primUrl('/stop-monitoring', { MonitoringRef: stopId }));
  const visits = parseStop(data); cont.innerHTML = '';
  if (!visits.length) { cont.innerHTML = '<div class="traffic-sub alert">üöß Aucun passage pr√©vu</div>'; return; }
  cont.classList.add('bus-grid');
  const byLine = {}; for (const v of visits) (byLine[v.lineId] ||= []).push(v);
  const sortedLines = Object.entries(byLine).sort(([a],[b]) => (a||'').localeCompare(b||''));
  for (const [lineId, rows] of sortedLines) {
    const meta = { code: lineId || '?', color: '#2450a4', textColor: '#fff' };
    const byDest = {}; for (const r of rows) (byDest[r.dest] ||= []).push(r);
    const sortedDest = Object.entries(byDest).sort(([a],[b]) => a.localeCompare(b,'fr',{sensitivity:'base'}));
    for (const [dest, list] of sortedDest) {
      const card = document.createElement('div'); card.className = 'bus-card';
      const header = document.createElement('div'); header.className = 'bus-card-header'; header.innerHTML = `<span class="line-pill" style="background:${meta.color};color:${meta.textColor}">${meta.code}</span> <span class="bus-card-dest">${dest}</span>`; card.appendChild(header);
      const timesEl = document.createElement('div'); timesEl.className = 'times';
      list.sort((a,b)=> (a.minutes??9e9)-(b.minutes??9e9)).slice(0,4).forEach(it => timesEl.insertAdjacentHTML('beforeend', formatTimeBox(it)));
      card.appendChild(timesEl); cont.appendChild(card);
    }
  }
  if (tEl) { tEl.textContent = 'Trafic normal'; tEl.className = 'traffic-sub ok'; tEl.style.display = 'inline-block'; }
}

// ===== Trafic (PRIM + fallback RATP) =====
function summarizeTrafficItem(item) {
  const title = cleanText(item?.title || '');
  const message = cleanText(item?.message || '');
  if (!message || message === title) return title; return `${title} ‚Äì ${message}`.trim();
}
async function refreshTransitTraffic() {
  const banner = document.getElementById('traffic-banner');
  const rerInfo = document.getElementById('rer-traffic');
  const events = document.getElementById('events-list');
  if (events) events.innerHTML = 'Chargement‚Ä¶';
  try {
    const impacted = []; let appended = false;
    const gmRer = await fetchJSON(primUrl('/general-message', { LineRef: LINES_SIRI.RER_A }));
    const infosRer = gmRer?.Siri?.ServiceDelivery?.GeneralMessageDelivery?.[0]?.InfoMessage || [];
    if (rerInfo) {
      if (infosRer.length) {
        const txt = cleanText(infosRer[0]?.Content?.Message?.[0]?.MessageText?.[0]?.value || infosRer[0]?.Content?.Message?.[0]?.MessageText?.value || '');
        rerInfo.style.display = 'block'; rerInfo.textContent = txt || 'Information trafic disponible'; rerInfo.className = 'traffic-sub alert';
        impacted.push({ label: 'RER A', detail: txt || 'Perturbation' });
      } else { rerInfo.style.display = 'block'; rerInfo.textContent = 'Trafic normal'; rerInfo.className = 'traffic-sub ok'; }
    }
    if (events) events.innerHTML = '';
    for (const [lbl, lineRef] of [['77', LINES_SIRI.BUS_77], ['201', LINES_SIRI.BUS_201]]) {
      const gm = await fetchJSON(primUrl('/general-message', { LineRef: lineRef }));
      const infos = gm?.Siri?.ServiceDelivery?.GeneralMessageDelivery?.[0]?.InfoMessage || [];
      const div = document.createElement('div');
      if (infos.length) {
        const txt = cleanText(infos[0]?.Content?.Message?.[0]?.MessageText?.[0]?.value || infos[0]?.Content?.Message?.[0]?.MessageText?.value || '');
        div.className = 'traffic-sub alert'; div.innerHTML = `<strong>Bus ${lbl}</strong> ‚Äî ${txt || 'Perturbation'}`;
        impacted.push({ label: `Bus ${lbl}`, detail: txt || 'Perturbation' });
      } else { div.className = 'traffic-sub ok'; div.textContent = `Bus ${lbl} ‚Äî Trafic normal`; }
      if (events) { events.appendChild(div); appended = true; }
    }
    if (events && !appended) { const div = document.createElement('div'); div.className = 'traffic-sub ok'; div.textContent = 'Trafic normal sur les bus suivis.'; events.appendChild(div); }
    if (banner) {
      if (impacted.length) { const list = impacted.map(i => i.label).join(', '); const detail = impacted[0].detail; banner.textContent = `‚ö†Ô∏è ${list} : ${detail}`; banner.className = 'traffic-banner alert'; }
      else { banner.textContent = 'üü¢ Trafic normal sur les lignes suivies.'; banner.className = 'traffic-banner ok'; }
    }
    return;
  } catch (e) { console.warn('PRIM general-message indisponible, fallback RATP‚Ä¶', e); }
  try {
    const data = await fetchJSON('https://api-ratp.pierre-grimaud.fr/v4/traffic', 10000);
    const result = data?.result; if (!result) throw new Error('no result');
    const impacted = [];
    const rerA = result.rers?.find(r => r.line === 'A');
    if (rerInfo) {
      if (rerA) { rerInfo.style.display = 'block'; rerInfo.textContent = summarizeTrafficItem(rerA); rerInfo.className = `traffic-sub ${rerA.slug === 'normal' ? 'ok' : 'alert'}`; if (rerA.slug !== 'normal') impacted.push({ label: 'RER A', detail: summarizeTrafficItem(rerA) }); }
      else { rerInfo.style.display = 'none'; }
    }
    const linesToWatch = ['77','201'];
    const busItems = linesToWatch.map(code => result.buses?.find(b => b.line === code)).filter(Boolean);
    if (events) { events.innerHTML = ''; if (!busItems.length) { const div = document.createElement('div'); div.className = 'traffic-sub ok'; div.textContent = 'Aucune information bus.'; events.appendChild(div); } else { let appended = false; busItems.forEach(item => { const div = document.createElement('div'); const alert = item.slug !== 'normal'; div.className = `traffic-sub ${alert ? 'alert' : 'ok'}`; div.innerHTML = `<strong>Bus ${item.line}</strong> ‚Äî ${summarizeTrafficItem(item)}`; events.appendChild(div); appended = true; if (alert) impacted.push({ label: `Bus ${item.line}`, detail: summarizeTrafficItem(item) }); }); if (!appended) { const div = document.createElement('div'); div.className = 'traffic-sub ok'; div.textContent = 'Trafic normal sur les bus suivis.'; events.appendChild(div); } } }
    if (banner) { if (impacted.length) { const list = impacted.map(i => i.label).join(', '); const detail = impacted[0].detail; banner.textContent = `‚ö†Ô∏è ${list} : ${detail}`; banner.className = 'traffic-banner alert'; } else { banner.textContent = 'üü¢ Trafic normal sur les lignes suivies.'; banner.className = 'traffic-banner ok'; } }
  } catch (e) {
    console.error('refreshTransitTraffic fallback RATP', e);
    const banner = document.getElementById('traffic-banner'); if (banner) { banner.textContent = '‚ö†Ô∏è Trafic indisponible'; banner.className = 'traffic-banner alert'; }
    const rerInfo = document.getElementById('rer-traffic'); if (rerInfo) rerInfo.style.display = 'none';
    const events = document.getElementById('events-list'); if (events) { events.innerHTML = '<div class="traffic-sub alert">Donn√©es trafic indisponibles</div>'; }
  }
}

// ===== M√©t√©o =====
const WEATHER_CODES = { 0:{emoji:'‚òÄÔ∏è',text:'Grand soleil'},1:{emoji:'üå§Ô∏è',text:'Ciel d√©gag√©'},2:{emoji:'‚õÖ',text:'√âclaircies'},3:{emoji:'‚òÅÔ∏è',text:'Ciel couvert'},45:{emoji:'üå´Ô∏è',text:'Brouillard'},48:{emoji:'üå´Ô∏è',text:'Brouillard givrant'},51:{emoji:'üå¶Ô∏è',text:'Bruine l√©g√®re'},53:{emoji:'üå¶Ô∏è',text:'Bruine'},55:{emoji:'üåßÔ∏è',text:'Forte bruine'},56:{emoji:'üåßÔ∏è',text:'Bruine vergla√ßante'},57:{emoji:'üåßÔ∏è',text:'Bruine vergla√ßante'},61:{emoji:'üå¶Ô∏è',text:'Pluie faible'},63:{emoji:'üåßÔ∏è',text:'Pluie'},65:{emoji:'üåßÔ∏è',text:'Pluie forte'},66:{emoji:'üåßÔ∏è',text:'Pluie vergla√ßante'},67:{emoji:'üåßÔ∏è',text:'Pluie vergla√ßante'},71:{emoji:'üå®Ô∏è',text:'Neige l√©g√®re'},73:{emoji:'üå®Ô∏è',text:'Neige'},75:{emoji:'‚ùÑÔ∏è',text:'Neige forte'},77:{emoji:'‚ùÑÔ∏è',text:'Gr√©sil'},80:{emoji:'üå¶Ô∏è',text:'Averses'},81:{emoji:'üåßÔ∏è',text:'Averses'},82:{emoji:'üåßÔ∏è',text:'Forte averse'},85:{emoji:'üå®Ô∏è',text:'Averses de neige'},86:{emoji:'‚ùÑÔ∏è',text:'Averses de neige'},95:{emoji:'‚õàÔ∏è',text:'Orages'},96:{emoji:'‚õàÔ∏è',text:'Orages gr√™le'},99:{emoji:'‚õàÔ∏è',text:'Orages gr√™le'} };
function describeWeather(code){ return WEATHER_CODES[code] || {emoji:'üå§Ô∏è',text:'M√©t√©o'}; }
async function refreshWeather(){
  const data = await fetchJSON(WEATHER_URL);
  const tempEl = document.getElementById('weather-temp');
  const emojiEl = document.getElementById('weather-emoji');
  const descEl = document.getElementById('weather-desc');
  if (!data?.current_weather){ if (descEl) descEl.textContent = 'M√©t√©o indisponible'; return; }
  const {temperature, weathercode} = data.current_weather; const info = describeWeather(weathercode); const tempStr = `${Math.round(temperature)}¬∞C`;
  if (tempEl) tempEl.textContent = tempStr; if (emojiEl) emojiEl.textContent = info.emoji; if (descEl) descEl.textContent = info.text;
}

// ===== V√©lib (Opendata Paris, robuste DNS) =====
async function refreshVelib(){
  await Promise.all(Object.entries(VELIB_STATIONS).map(async ([key, id]) => {
    const el = document.getElementById(`velib-${key.toLowerCase()}`); if (!el) return;
    try {
      const url = `https://opendata.paris.fr/api/explore/v2.1/catalog/datasets/velib-disponibilite-en-temps-reel/records?where=stationcode%3D${id}&limit=1`;
      const data = await fetchJSON(url);
      const st = data?.results?.[0]; if (!st) { el.textContent = 'Indispo'; return; }
      const mech = st.mechanical_bikes || 0; const elec = st.ebike_bikes || 0; const docks = st.numdocksavailable || 0;
      el.textContent = `üö≤${mech} üîå${elec} üÖøÔ∏è${docks}`;
    } catch(e){ console.error('refreshVelib', key, e); el.textContent = 'Indispo'; }
  }));
}

// ===== News =====
async function refreshNews(){
  const xml = await fetchText(PROXY + encodeURIComponent(RSS_URL));
  let items = [];
  if (xml){
    try{
      const doc = new DOMParser().parseFromString(xml, 'application/xml');
      items = [...doc.querySelectorAll('item')].slice(0,5).map(node=>({
        title: cleanText(node.querySelector('title')?.textContent || ''),
        desc: cleanText(node.querySelector('description')?.textContent || '')
      }));
    }catch(e){ console.error('refreshNews', e); }
  }
  const cont = document.getElementById('news-carousel');
  if (!cont) return; cont.innerHTML = '';
  if (!items.length){ cont.textContent = 'Aucune actualit√©'; return; }
  items.forEach((item, idx)=>{
    const card = document.createElement('div'); card.className = 'news-card' + (idx===0 ? ' active' : '');
    card.innerHTML = `<div>${item.title}</div><div>${item.desc}</div>`; cont.appendChild(card);
  });
}

// ===== Ticker, Horoscope, Saint =====
let tickerIndex = 0; let tickerData = { timeWeather:'', saint:'', horoscope:'', traffic:'' }; let signIdx = 0;
const SIGNS = [{fr:'B√©lier',en:'Aries'},{fr:'Taureau',en:'Taurus'},{fr:'G√©meaux',en:'Gemini'},{fr:'Cancer',en:'Cancer'},{fr:'Lion',en:'Leo'},{fr:'Vierge',en:'Virgo'},{fr:'Balance',en:'Libra'},{fr:'Scorpion',en:'Scorpio'},{fr:'Sagittaire',en:'Sagittarius'},{fr:'Capricorne',en:'Capricorn'},{fr:'Verseau',en:'Aquarius'},{fr:'Poissons',en:'Pisces'}];
async function fetchHoroscope(signEn){ try{ const url = `https://horoscope-app-api.vercel.app/api/v1/get-horoscope/daily?sign=${signEn}&day=today`; const data = await fetchJSON(PROXY + encodeURIComponent(url)); return data?.data?.horoscope_data || 'Horoscope indisponible.'; }catch{ return 'Horoscope indisponible.'; } }
async function refreshHoroscopeCycle(){ const {fr,en} = SIGNS[signIdx]; const text = await fetchHoroscope(en); tickerData.horoscope = `üîÆ ${fr} : ${text}`; signIdx = (signIdx+1)%SIGNS.length; }
async function refreshSaint(){ try{ const data = await fetchJSON('https://nominis.cef.fr/json/nominis.php'); const name = data?.response?.prenoms; tickerData.saint = name ? `üéÇ Ste ${name}` : 'üéÇ F√™te du jour'; }catch{ tickerData.saint = 'üéÇ F√™te du jour indisponible'; } }
function updateTicker(){ const slot = document.getElementById('ticker-slot'); if (!slot) return; const clock = `${new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`; const entries = [`${clock} ‚Ä¢ ${tickerData.timeWeather}`]; if (tickerData.saint) entries.push(tickerData.saint); if (tickerData.horoscope) entries.push(tickerData.horoscope); if (tickerData.traffic) entries.push(tickerData.traffic); const pool = entries.filter(Boolean); if (!pool.length){ slot.textContent = 'Chargement‚Ä¶'; return; } slot.textContent = pool[tickerIndex % pool.length]; tickerIndex++; }

// ===== Courses (fallback letrot) =====
async function refreshCourses(){ const cont = document.getElementById('courses-list'); if (!cont) return; cont.textContent = 'Chargement‚Ä¶'; try { const html = await fetchText('https://r.jina.ai/https://www.letrot.com/stats/Evenement/GetEvenements?hippodrome=VINCENNES&startDate=' + new Date().toISOString().slice(0,10) + '&endDate=' + new Date(Date.now()+90*86400000).toISOString().slice(0,10)); const entries = [...html.matchAll(/(\d{1,2} \w+ \d{4}).*?R√©union\s*(\d+)/gis)].map(m=>({date:m[1],reunion:m[2]})); cont.innerHTML=''; if (!entries.length) throw new Error('no entries'); entries.slice(0,4).forEach(({date,reunion})=>{ const div=document.createElement('div'); div.className='traffic-sub ok'; div.textContent=`${date} ‚Äî R√©union ${reunion}`; cont.appendChild(div); }); } catch(e){ console.warn('refreshCourses', e); cont.innerHTML = '<div class="traffic-sub alert">Programme indisponible. Consultez le site officiel.</div>'; } }

// ===== Boucles =====
function startLoops(){
  setInterval(setClock, 1000);
  setInterval(renderRer, 60000);
  setInterval(()=>renderBusForStop(STOP_IDS.HIPPODROME, 'bus-hippodrome-body', 'bus-hippodrome-traffic'), 60000);
  setInterval(()=>renderBusForStop(STOP_IDS.BREUIL, 'bus-breuil-body', 'bus-breuil-traffic'), 60000);
  setInterval(refreshVelib, 180000);
  setInterval(refreshWeather, 1800000);
  setInterval(refreshNews, 900000);
  setInterval(refreshHoroscopeCycle, 60000);
  setInterval(refreshSaint, 3600000);
  setInterval(refreshTransitTraffic, 120000);
  setInterval(refreshCourses, 900000);
  setInterval(()=>{ updateTicker(); setLastUpdate(); }, 10000);
}

// ===== Init =====
document.addEventListener('DOMContentLoaded', async ()=>{
  setClock();
  await Promise.allSettled([
    renderRer(),
    renderBusForStop(STOP_IDS.HIPPODROME, 'bus-hippodrome-body', 'bus-hippodrome-traffic'),
    renderBusForStop(STOP_IDS.BREUIL, 'bus-breuil-body', 'bus-breuil-traffic'),
    refreshVelib(), refreshWeather(), refreshNews(), refreshHoroscopeCycle(), refreshSaint(), refreshTransitTraffic(), refreshCourses()
  ]);
  updateTicker(); setLastUpdate(); startLoops();
});
